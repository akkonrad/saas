name: Deploy Koalka Landing

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # Nx uses SHAs to determine what has changed
      # This action sets NX_BASE and NX_HEAD environment variables
      - name: Derive appropriate SHAs for base and head for nx affected
        uses: nrwl/nx-set-shas@v4

      - name: Check if koalka-landing is affected
        id: affected
        run: |
          # Manual trigger always deploys
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "is_affected=true" >> $GITHUB_OUTPUT
            echo "ðŸ”§ Manual trigger - will build and deploy"
            exit 0
          fi

          # Check if koalka-landing is in the list of affected projects
          AFFECTED=$(npx nx show projects --affected --base=$NX_BASE --head=$NX_HEAD)
          echo "Affected projects:"
          echo "$AFFECTED"

          if echo "$AFFECTED" | grep -q "koalka-landing"; then
            echo "is_affected=true" >> $GITHUB_OUTPUT
            echo "âœ… koalka-landing IS affected - will build and deploy"
          else
            echo "is_affected=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ koalka-landing is NOT affected - skipping deployment"
          fi

      - name: Build koalka-landing
        if: steps.affected.outputs.is_affected == 'true'
        run: npx nx build koalka-landing --configuration=production

      - name: Deploy to Production (OVH) via SFTP
        if: steps.affected.outputs.is_affected == 'true'
        env:
          KOALKA_LANDING_SFTP_HOST: ${{ secrets.KOALKA_LANDING_SFTP_HOST }}
          KOALKA_LANDING_SFTP_PORT: ${{ secrets.KOALKA_LANDING_SFTP_PORT }}
          KOALKA_LANDING_SFTP_USER: ${{ secrets.KOALKA_LANDING_SFTP_USER }}
          KOALKA_LANDING_SFTP_PASSWORD: ${{ secrets.KOALKA_LANDING_SFTP_PASSWORD }}
          KOALKA_LANDING_SFTP_REMOTE_PATH: ${{ secrets.KOALKA_LANDING_SFTP_REMOTE_PATH }}
        run: node tools/scripts/deploy-sftp.mjs KOALKA_LANDING dist/apps/koalka/landing/browser

      - name: Summary
        run: |
          if [ "${{ steps.affected.outputs.is_affected }}" == "true" ]; then
            echo "### âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
            echo "koalka-landing was deployed to production." >> $GITHUB_STEP_SUMMARY
          else
            echo "### â­ï¸ Deployment Skipped" >> $GITHUB_STEP_SUMMARY
            echo "koalka-landing was not affected by this change." >> $GITHUB_STEP_SUMMARY
          fi

# Required GitHub Secrets:
# - KOALKA_LANDING_SFTP_HOST: ftp.cluster121.hosting.ovh.net
# - KOALKA_LANDING_SFTP_PORT: 22
# - KOALKA_LANDING_SFTP_USER: koalkar
# - KOALKA_LANDING_SFTP_PASSWORD: SFTP password
# - KOALKA_LANDING_SFTP_REMOTE_PATH: /home/koalkar/www
